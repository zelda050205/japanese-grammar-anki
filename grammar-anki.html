<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­è¯­æ³•è®°å¿†ç³»ç»Ÿ - Ankié£æ ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 450px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .screen {
            display: none;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }
        
        .screen.active {
            display: block;
        }
        
        /* ä¸»èœå•æ ·å¼ */
        .menu-btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-learn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .btn-review { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .btn-browse { background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); color: white; }
        .btn-stats { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
        .btn-upload { background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%); color: white; }
        
        .btn-count {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }
        
        /* è¯¾ç¨‹åˆ—è¡¨æ ·å¼ */
        .lesson-list {
            margin-top: 10px;
        }
        
        .lesson-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin: 10px 0;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .lesson-item:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .lesson-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .lesson-subtitle {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .lesson-progress {
            text-align: right;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
        }
        
        .progress-bar {
            width: 60px;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }
        
        /* è¯­æ³•åˆ—è¡¨æ ·å¼ */
        .grammar-list {
            margin-top: 10px;
        }
        
        .grammar-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin: 10px 0;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .grammar-item:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .grammar-pattern {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
        }
        
        .grammar-meaning {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .grammar-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
        }
        
        .status-new { background: #6c757d; }
        .status-learning { background: #ffc107; color: #333; }
        .status-review { background: #28a745; }
        .status-mastered { background: #6f42c1; }
        
        .next-review {
            font-size: 12px;
            color: #666;
        }
        
        /* å­¦ä¹ å¡ç‰‡æ ·å¼ */
        .study-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }
        
        .study-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }
        
        .card-front .pattern {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
        }
        
        .card-back .meaning {
            font-size: 24px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .card-back .connection {
            font-size: 16px;
            color: #555;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            white-space: pre-line;
            text-align: left;
        }
        
        .card-back .notes {
            font-size: 14px;
            color: #666;
            background: #fff3cd;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-bottom: 15px;
            text-align: left;
        }
        
        .examples {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
        }
        
        .example-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .example-item:hover {
            background: #e9ecef;
        }
        
        .example-japanese {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
            line-height: 2.2;
            position: relative;
        }
        
        .example-chinese {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        /* å‡åæ ‡æ³¨æ ·å¼ */
        .furigana-text {
            position: relative;
            display: inline-block;
        }
        
        .furigana {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            white-space: nowrap;
            font-weight: normal;
        }
        
        /* è¯­æ³•é«˜äº®æ ·å¼ */
        .grammar-highlight {
            color: #007bff;
            font-weight: bold;
            font-size: 20px;
        }
        
        .flip-hint {
            font-size: 14px;
            color: #999;
            margin-top: 15px;
            opacity: 0.8;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .btn-again { background: #dc3545; }
        .btn-hard { background: #ffc107; color: #333; }
        .btn-good { background: #28a745; }
        .btn-easy { background: #17a2b8; }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .back-btn:hover {
            background: #5a6268;
        }
        
        .hidden { display: none !important; }
        
        .progress-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .session-progress {
            background: #e9ecef;
            height: 4px;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .session-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }
        
        /* ä¸Šä¼ ç•Œé¢æ ·å¼ */
        .upload-container {
            max-width: 100%;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }
        
        .upload-area.dragover {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .upload-text p {
            margin: 5px 0;
            color: #666;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #999;
        }
        
        .format-guide {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .format-guide h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .format-example {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .format-example pre {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
            color: #333;
        }
        
        .format-notes {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .format-notes ul {
            margin: 10px 0 0 20px;
        }
        
        .format-notes li {
            margin: 5px 0;
            color: #856404;
        }
        
        .upload-result {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .upload-result h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .parse-result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .parsed-lesson {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .parsed-lesson h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .parsed-grammar {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #4facfe;
        }
        
        .parsed-pattern {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        .parsed-meaning {
            color: #666;
            font-size: 13px;
            margin: 5px 0;
        }
        
        .parsed-examples {
            font-size: 12px;
            color: #777;
            margin-top: 8px;
        }
        
        .upload-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-confirm {
            background: #28a745;
            color: white;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>æ—¥è¯­è¯­æ³•è®°å¿†ç³»ç»Ÿ</h1>
            <div class="stats">
                <span>ä»Šæ—¥æ–°å­¦: <span id="today-new">0</span></span>
                <span>ä»Šæ—¥å¤ä¹ : <span id="today-review">0</span></span>
                <span>å¾…å¤ä¹ : <span id="due-count">0</span></span>
            </div>
        </div>

        <!-- ä¸»èœå• -->
        <div id="main-menu" class="screen active">
            <button class="menu-btn btn-learn" onclick="showLessonList('learn')">
                <span>ğŸ“š å­¦ä¹ æ–°è¯­æ³•</span>
                <span class="btn-count" id="new-count">5</span>
            </button>
            
            <button class="menu-btn btn-review" onclick="startReview()">
                <span>ğŸ”„ å¤ä¹ è¯­æ³•</span>
                <span class="btn-count" id="review-count">0</span>
            </button>
            
            <button class="menu-btn btn-browse" onclick="showLessonList('browse')">
                <span>ğŸ“– æµè§ˆè¯­æ³•</span>
                <span class="btn-count">âˆ</span>
            </button>
            
            <button class="menu-btn btn-stats" onclick="showStats()">
                <span>ğŸ“Š å­¦ä¹ ç»Ÿè®¡</span>
                <span class="btn-count">ğŸ“ˆ</span>
            </button>
            
            <button class="menu-btn btn-upload" onclick="showUpload()">
                <span>ğŸ“¤ ä¸Šä¼ è¯­æ³•</span>
                <span class="btn-count">+</span>
            </button>
        </div>

        <!-- è¯¾ç¨‹åˆ—è¡¨ -->
        <div id="lesson-list" class="screen">
            <button class="back-btn" onclick="backToMenu()">â† è¿”å›ä¸»èœå•</button>
            <h2 id="lesson-list-title">é€‰æ‹©è¯¾ç¨‹</h2>
            <div class="lesson-list" id="lessons-container">
                <!-- è¯¾ç¨‹åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- è¯­æ³•åˆ—è¡¨ -->
        <div id="grammar-list" class="screen">
            <button class="back-btn" onclick="backToLessonList()">â† è¿”å›è¯¾ç¨‹åˆ—è¡¨</button>
            <h2 id="grammar-list-title">ç¬¬ä¸€è¯¾è¯­æ³•</h2>
            <div class="grammar-list" id="grammar-container">
                <!-- è¯­æ³•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å­¦ä¹ ç•Œé¢ -->
        <div id="study-screen" class="screen">
            <button class="back-btn" onclick="backToMenu()">â† è¿”å›ä¸»èœå•</button>
            
            <div class="progress-info">
                <div id="study-progress-text">ç¬¬ 1 å¼  / å…± 5 å¼ </div>
                <div class="session-progress">
                    <div class="session-progress-fill" id="study-progress-bar"></div>
                </div>
            </div>
            
            <div class="study-card" onclick="flipCard()">
                <div id="card-front" class="card-front">
                    <div class="pattern" id="study-pattern">ï½éš›ï¼ˆã«ï¼‰</div>
                    <div class="flip-hint">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
                
                <div id="card-back" class="card-back hidden">
                    <div class="meaning" id="study-meaning">åœ¨ï½æ—¶å€™ã€åœ¨ï½æ—¶æœº</div>
                    <div class="connection" id="study-connection">åŠ¨è¯è¾ä¹¦å½¢/ãŸå½¢ + éš›ï¼ˆã«ï¼‰</div>
                    <div class="notes" id="study-notes">ç¡¬ã„è¨€ã„æ–¹ï¼Œæ­£å¼åœºåˆä½¿ç”¨</div>
                    <div class="examples" id="study-examples">
                        <!-- ä¾‹å¥å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                    </div>
                </div>
            </div>
            
            <div class="action-buttons hidden" id="study-buttons">
                <button class="action-btn btn-again" onclick="answerCard(1)">é‡æ¥<br><small>1åˆ†é’Ÿ</small></button>
                <button class="action-btn btn-hard" onclick="answerCard(2)">å›°éš¾<br><small>6åˆ†é’Ÿ</small></button>
                <button class="action-btn btn-good" onclick="answerCard(3)">è‰¯å¥½<br><small>1å¤©</small></button>
                <button class="action-btn btn-easy" onclick="answerCard(4)">ç®€å•<br><small>4å¤©</small></button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ç•Œé¢ -->
        <div id="stats-screen" class="screen">
            <button class="back-btn" onclick="backToMenu()">â† è¿”å›ä¸»èœå•</button>
            <h2>å­¦ä¹ ç»Ÿè®¡</h2>
            <div id="stats-content">
                <!-- ç»Ÿè®¡å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- ä¸Šä¼ ç•Œé¢ -->
        <div id="upload-screen" class="screen">
            <button class="back-btn" onclick="backToMenu()">â† è¿”å›ä¸»èœå•</button>
            <h2>ä¸Šä¼ è‡ªå®šä¹‰è¯­æ³•</h2>
            
            <div class="upload-container">
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">
                        <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                        <p class="upload-hint">æ”¯æŒ .txt æ ¼å¼æ–‡ä»¶</p>
                    </div>
                    <input type="file" id="file-input" accept=".txt" style="display: none;">
                </div>
                
                <div class="format-guide">
                    <h3>ğŸ“‹ æ–‡ä»¶æ ¼å¼è¯´æ˜</h3>
                    <div class="format-example">
                        <p><strong>æ”¯æŒå¤šè¯¾æ—¶æ ¼å¼ï¼š</strong></p>
                        <pre>ç¬¬2è¯¾
å¿˜ã‚Œãªã„ã†ã¡ã«ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ãƒ¡ãƒ¢ã—ã¦ãŠã“ã†ã€‚
è¶ç€æ²¡å¿˜ï¼Œå…ˆè®°åœ¨æ—¥å†ä¸Šå§ã€‚
ã€Œã€œã†ã¡ã«ã€ï¼šA:"è¶ç€ï½èµ¶ç´§"+æ„å¿—ï¼›B:å+ä¸çŸ¥ä¸è§‰ã€è‡ªç„¶è€Œç„¶çš„å˜åŒ–ï¼›ä¸+æ„å¿—
æµœè¾ºã§ãƒãƒ¼ãƒ™ã‚­ãƒ¥ãƒ¼ã‚’ã‚„ã£ã¦ã„ã‚‹æœ€ä¸­ã«ã€æ€¥ã«é›¨ãŒé™ã‚Šå‡ºã—ãŸã€‚
æ­£åœ¨æµ·è¾¹çƒ§çƒ¤çš„æ—¶å€™ï¼Œçªç„¶ä¸‹èµ·é›¨æ¥ã€‚
ã€Œã€œæœ€ä¸­(ã«)ï¼ã€œæœ€ä¸­ã ã€ï¼š"æ­£åœ¨ï½"ï¼Œå+å¦¨ç¢çš„äº‹æƒ…

ç¬¬3è¯¾
å½¼å¥³ã¯æ¯æ—¥é…åˆ»ã°ã‹ã‚Šã—ã¦ã„ã‚‹ã€‚
å¥¹æ¯å¤©éƒ½åœ¨è¿Ÿåˆ°ã€‚
ã€Œã€œã°ã‹ã‚Šã ã€ï¼šè¡¨ç¤ºä¸æ–­é‡å¤æŸç§ä¸å¥½çš„è¡Œä¸º
æœ€è¿‘å¿™ã—ãã¦ã€ç–²ã‚Œã‚‹ä¸€æ–¹ã ã€‚
æœ€è¿‘å¾ˆå¿™ï¼Œè¶Šæ¥è¶Šç´¯ã€‚
ã€Œã€œä¸€æ–¹ã ã€ï¼šè¡¨ç¤ºæœç€æŸä¸ªæ–¹å‘ä¸æ–­å‘å±•</pre>
                    </div>
                    <div class="format-notes">
                        <p><strong>æ ¼å¼è¯´æ˜ï¼š</strong></p>
                        <ul>
                            <li>âœ… <strong>æ”¯æŒå¤šè¯¾æ—¶</strong>ï¼šä¸€ä¸ªæ–‡æ¡£å¯ä»¥åŒ…å«å¤šä¸ªè¯¾ç¨‹</li>
                            <li>ğŸ“š è¯¾ç¨‹æ ‡é¢˜ï¼šç¬¬Xè¯¾ï¼ˆå¦‚ï¼šç¬¬2è¯¾ã€ç¬¬3è¯¾ã€ç¬¬10è¯¾ï¼‰</li>
                            <li>ğŸ“ æ¯3è¡Œä¸ºä¸€ç»„ï¼šæ—¥è¯­ä¾‹å¥ â†’ ä¸­æ–‡ç¿»è¯‘ â†’ è¯­æ³•è§£é‡Š</li>
                            <li>ğŸ”¤ è¯­æ³•è§£é‡Šæ ¼å¼ï¼šã€Œè¯­æ³•ç‚¹ã€ï¼šè¯´æ˜å†…å®¹</li>
                            <li>ğŸ”„ è¯¾ç¨‹ä¹‹é—´å¯ç”¨ç©ºè¡Œåˆ†éš”ï¼ˆå¯é€‰ï¼‰</li>
                            <li>ğŸ’¾ æ–‡ä»¶ç¼–ç è¯·ä½¿ç”¨ UTF-8</li>
                        </ul>
                    </div>
                </div>
                
                <div class="upload-result" id="upload-result" style="display: none;">
                    <h3>ğŸ“Š è§£æç»“æœ</h3>
                    <div id="parse-result"></div>
                    <div class="upload-actions">
                        <button class="action-btn btn-confirm" onclick="confirmUpload()">ç¡®è®¤æ·»åŠ </button>
                        <button class="action-btn btn-cancel" onclick="cancelUpload()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¯¾ç¨‹æ•°æ®ç»“æ„
        const lessonsData = {
            1: {
                title: "ç¬¬01è¯¾ï¼šï½ã¨ããƒ»ï½ç›´å¾Œã«",
                subtitle: "ï¼ˆåœ¨ï½æ—¶å€™ãƒ»åˆšï½ä¹‹åï¼‰",
                grammar: []
            },
            2: {
                title: "ç¬¬02è¯¾ï¼šï½ã—ã¦ã„ã‚‹ï¼ˆé€²è¡Œä¸­ï¼‰",
                subtitle: "ï¼ˆæ­£åœ¨è¿›è¡Œä¸­ï¼‰",
                grammar: []
            },
            3: {
                title: "ç¬¬03è¯¾ï¼šï½å¾Œã§",
                subtitle: "ï¼ˆåœ¨ï½ä¹‹åï¼‰",
                grammar: []
            },
            4: {
                title: "ç¬¬04è¯¾ï¼šç¯„å›²ã®å§‹ã¾ã‚Šã¨çµ‚ã‚ã‚Šãƒ»ãã®é–“",
                subtitle: "ï¼ˆèŒƒå›´çš„å¼€å§‹ä¸ç»“æŸãƒ»å…¶é—´ï¼‰",
                grammar: []
            },
            5: {
                title: "ç¬¬05è¯¾ï¼šï½ã ã‘",
                subtitle: "ï¼ˆé™å®šã€å°½å¯èƒ½ï¼‰",
                grammar: []
            },
            6: {
                title: "ç¬¬06è¯¾ï¼šï½ã ã‘ã§ã¯ãªããƒ»ãã‚Œã«åŠ ãˆã¦",
                subtitle: "ï¼ˆä¸ä»…ï½è€Œä¸”ã€å†åŠ ä¸Šï¼‰",
                grammar: []
            },
            7: {
                title: "ç¬¬07è¯¾ï¼šï½ã«ã¤ã„ã¦ãƒ»ï½ã‚’ç›¸æ‰‹ã«ã—ã¦",
                subtitle: "ï¼ˆå…³äºï½ãƒ»ä»¥ï½ä¸ºå¯¹è±¡ï¼‰",
                grammar: []
            },
            8: {
                title: "ç¬¬08è¯¾ï¼šï½ã‚’åŸºæº–ã«ã—ã¦",
                subtitle: "ï¼ˆä»¥ï½ä¸ºåŸºå‡†ï¼‰",
                grammar: []
            },
            9: {
                title: "ç¬¬09è¯¾ï¼šï½ã«é–¢é€£ã—ã¦ãƒ»ï½ã«å¯¾å¿œã—ã¦",
                subtitle: "ï¼ˆä¸ï½ç›¸å…³ãƒ»ä¸ï½ç›¸å¯¹åº”ï¼‰",
                grammar: []
            },
            10: {
                title: "ç¬¬10è¯¾ï¼šï½ã‚„ï½ãªã©",
                subtitle: "ï¼ˆï½æˆ–ï½ä¹‹ç±»ï¼‰",
                grammar: []
            },
            11: {
                title: "ç¬¬11è¯¾ï¼šï½ã«é–¢ä¿‚ãªããƒ»ç„¡è¦–ã—ã¦",
                subtitle: "ï¼ˆä¸ï½æ— å…³ãƒ»æ— è§†ï½ï¼‰",
                grammar: []
            },
            12: {
                title: "ç¬¬12è¯¾ï¼šå¼·ãå¦å®šã™ã‚‹ãƒ»å¼·ãå¦å®šã—ãªã„",
                subtitle: "ï¼ˆå¼ºçƒˆå¦å®šãƒ»å¹¶éå®Œå…¨å¦å®šï¼‰",
                grammar: []
            },
            13: {
                title: "ç¬¬13è¯¾ï¼šï½ï¼ˆè©±é¡Œï¼‰ã¯",
                subtitle: "ï¼ˆå…³äºè¯é¢˜ï½ï¼‰",
                grammar: []
            },
            14: {
                title: "ç¬¬14è¯¾ï¼šï½ã‘ã‚Œã©",
                subtitle: "ï¼ˆè™½ç„¶ï½ä½†æ˜¯ï¼‰",
                grammar: []
            },
            15: {
                title: "ç¬¬15è¯¾ï¼šã‚‚ã—ãã†ãªã‚‰ãƒ»ãŸã¨ãˆãã†ã§ã‚‚",
                subtitle: "ï¼ˆå¦‚æœæ˜¯é‚£æ ·ãƒ»å³ä½¿æ˜¯é‚£æ ·ï¼‰",
                grammar: []
            },
            16: {
                title: "ç¬¬16è¯¾ï¼šï½ã ã‹ã‚‰ï¼ˆç†ç”±ï¼‰-1",
                subtitle: "ï¼ˆå› ä¸ºï½ï¼ˆç†ç”±ï¼‰-1ï¼‰",
                grammar: []
            },
            17: {
                title: "ç¬¬17è¯¾ï¼šï½ã ã‹ã‚‰ï¼ˆç†ç”±ï¼‰-2",
                subtitle: "ï¼ˆå› ä¸ºï½ï¼ˆç†ç”±ï¼‰-2ï¼‰",
                grammar: []
            },
            18: {
                title: "ç¬¬18è¯¾ï¼šï½ã§ããªã„ãƒ»å›°é›£ã ãƒ»ï½ã§ãã‚‹",
                subtitle: "ï¼ˆä¸èƒ½ãƒ»å›°éš¾ãƒ»èƒ½ï¼‰",
                grammar: []
            },
            19: {
                title: "ç¬¬19è¯¾ï¼šï½ã‚’è¦‹ã¦è©•ä¾¡ã™ã‚‹ã¨ãƒ»ï½ã®ç«‹å ´ã§...",
                subtitle: "ï¼ˆé€šè¿‡çœ‹ï½æ¥è¯„ä»·ãƒ»ç«™åœ¨ï½çš„ç«‹åœº...ï¼‰",
                grammar: []
            },
            20: {
                title: "ç¬¬20è¯¾ï¼šçµæœã¯ã©ã†ãªã£ãŸã‹",
                subtitle: "ï¼ˆç»“æœæ˜¯æ€ä¹ˆæ ·çš„ï¼‰",
                grammar: []
            },
            21: {
                title: "ç¬¬21è¯¾ï¼šå¼·ãè¨€ã†ãƒ»è»½ãè¨€ã†",
                subtitle: "ï¼ˆå¼ºç¡¬åœ°è¯´ãƒ»å§”å©‰åœ°è¯´ï¼‰",
                grammar: []
            },
            22: {
                title: "ç¬¬22è¯¾ï¼šï½ã ã‚ã†ã¨æ€ã†",
                subtitle: "ï¼ˆæˆ‘æƒ³å¤§æ¦‚æ˜¯ï½å§ï¼‰",
                grammar: []
            },
            23: {
                title: "ç¬¬23è¯¾ï¼šæ„Ÿæƒ³ã‚’è¨€ã†ãƒ»ä¸»å¼µã™ã‚‹",
                subtitle: "ï¼ˆå‘è¡¨æ„Ÿæƒ³ãƒ»ä¸»å¼ ï¼‰",
                grammar: []
            },
            24: {
                title: "ç¬¬24è¯¾ï¼šææ¡ˆã™ã‚‹ãƒ»æ„å¿—ã‚’è¡¨ã™",
                subtitle: "ï¼ˆææ¡ˆãƒ»è¡¨è¾¾æ„å¿—ï¼‰",
                grammar: []
            },
            25: {
                title: "ç¬¬25è¯¾ï¼šå¼·ããã†æ„Ÿã˜ã‚‹ãƒ»æ€ã„ãŒå¼·ã„ã‚‰ã‚Œã‚‹",
                subtitle: "ï¼ˆæ„Ÿè§¦å¼ºçƒˆãƒ»è¢«è¿«ï¼‰",
                grammar: []
            },
            26: {
                title: "ç¬¬26è¯¾ï¼šé¡˜ã†ãƒ»æ„Ÿå‹•ã™ã‚‹",
                subtitle: "ï¼ˆç¥ˆæ„¿ãƒ»æ„ŸåŠ¨ï¼‰",
                grammar: []
            }
        };

        // åº”ç”¨çŠ¶æ€
        let currentMode = 'menu'; // menu, lesson-list, grammar-list, study, stats
        let currentLesson = null;
        let currentStudyCards = [];
        let currentCardIndex = 0;
        let isCardFlipped = false;
        let studyMode = 'learn'; // learn, review, browse

        // æœ¬åœ°å­˜å‚¨ç®¡ç†
        class StorageManager {
            static getCardProgress(cardId) {
                const progress = localStorage.getItem('cardProgress');
                const data = progress ? JSON.parse(progress) : {};
                return data[cardId] || {
                    id: cardId,
                    status: 'new', // new, learning, review, mastered
                    interval: 0,
                    easeFactor: 2.5,
                    reviewCount: 0,
                    lastReviewed: null,
                    nextReview: null
                };
            }

            static saveCardProgress(cardId, progress) {
                const allProgress = localStorage.getItem('cardProgress');
                const data = allProgress ? JSON.parse(allProgress) : {};
                data[cardId] = progress;
                localStorage.setItem('cardProgress', JSON.stringify(data));
            }

            static getTodayStats() {
                const today = new Date().toDateString();
                const stats = localStorage.getItem('todayStats');
                const data = stats ? JSON.parse(stats) : {};
                
                if (data.date !== today) {
                    return { date: today, newCards: 0, reviewCards: 0 };
                }
                return data;
            }

            static updateTodayStats(type) {
                const today = new Date().toDateString();
                let stats = this.getTodayStats();
                
                if (type === 'new') {
                    stats.newCards = (stats.newCards || 0) + 1;
                } else if (type === 'review') {
                    stats.reviewCards = (stats.reviewCards || 0) + 1;
                }
                
                stats.date = today;
                localStorage.setItem('todayStats', JSON.stringify(stats));
            }
        }

        // é—´éš”é‡å¤ç®—æ³• - ä¸¥æ ¼æŒ‰ç…§Ankié€»è¾‘
        class SpacedRepetition {
            static calculateNextReview(progress, quality) {
                // quality: 1=again, 2=hard, 3=good, 4=easy
                const now = Date.now();
                let interval = progress.interval || 0;
                let easeFactor = progress.easeFactor || 2.5;
                let graduated = false; // æ˜¯å¦ä»å­¦ä¹ é˜¶æ®µæ¯•ä¸š

                if (progress.status === 'new' || progress.status === 'learning') {
                    // å­¦ä¹ é˜¶æ®µ
                    if (quality < 3) {
                        // å›ç­”é”™è¯¯ï¼Œé‡æ–°å¼€å§‹å­¦ä¹ æ­¥éª¤
                        progress.learningStep = 0;
                        interval = quality === 1 ? 1 : 6; // 1åˆ†é’Ÿæˆ–6åˆ†é’Ÿ
                        progress.status = 'learning';
                    } else {
                        // å›ç­”æ­£ç¡®ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå­¦ä¹ æ­¥éª¤
                        const learningSteps = [1, 10]; // 1åˆ†é’Ÿï¼Œ10åˆ†é’Ÿ
                        progress.learningStep = (progress.learningStep || 0) + 1;
                        
                        if (progress.learningStep >= learningSteps.length) {
                            // å®Œæˆå­¦ä¹ é˜¶æ®µï¼Œæ¯•ä¸šåˆ°å¤ä¹ 
                            interval = quality === 3 ? 1 : 4; // 1å¤©æˆ–4å¤©
                            progress.status = 'review';
                            graduated = true;
                        } else {
                            // è¿˜åœ¨å­¦ä¹ é˜¶æ®µ
                            interval = learningSteps[progress.learningStep];
                            progress.status = 'learning';
                        }
                    }
                } else {
                    // å¤ä¹ é˜¶æ®µ
                    if (quality < 3) {
                        // å›ç­”é”™è¯¯ï¼Œå›åˆ°å­¦ä¹ é˜¶æ®µ
                        progress.learningStep = 0;
                        interval = 1; // 1åˆ†é’Ÿ
                        progress.status = 'learning';
                        // é™ä½éš¾åº¦å› å­
                        easeFactor = Math.max(1.3, easeFactor - 0.2);
                    } else {
                        // å›ç­”æ­£ç¡®ï¼Œè®¡ç®—æ–°çš„å¤ä¹ é—´éš”
                        if (interval === 0) interval = 1;
                        
                        // è°ƒæ•´éš¾åº¦å› å­
                        easeFactor = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                        easeFactor = Math.max(1.3, easeFactor);
                        
                        // è®¡ç®—æ–°é—´éš”
                        interval = Math.round(interval * easeFactor);
                        
                        // æ ¹æ®é—´éš”é•¿åº¦ç¡®å®šçŠ¶æ€
                        if (interval >= 21) {
                            progress.status = 'review';
                        }
                        if (interval >= 180) {
                            progress.status = 'mastered';
                        }
                        graduated = true;
                    }
                }

                progress.interval = interval;
                progress.easeFactor = easeFactor;
                progress.reviewCount++;
                progress.lastReviewed = now;
                
                // è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¶é—´
                const nextReview = now + (interval * (interval < 60 ? 60000 : 86400000)); // åˆ†é’Ÿæˆ–å¤©
                progress.nextReview = nextReview;

                return { progress, graduated };
            }

            static getDueCards() {
                const now = Date.now();
                const dueCards = [];
                
                // éå†æ‰€æœ‰è¯¾ç¨‹çš„æ‰€æœ‰è¯­æ³•
                Object.values(lessonsData).forEach(lesson => {
                    lesson.grammar.forEach(grammar => {
                        const progress = StorageManager.getCardProgress(grammar.id);
                        if (progress.nextReview && progress.nextReview <= now) {
                            dueCards.push({...grammar, progress});
                        }
                    });
                });
                
                return dueCards;
            }

            static getNewCards(limit = 20) {
                const newCards = [];
                
                // éå†æ‰€æœ‰è¯¾ç¨‹çš„æ‰€æœ‰è¯­æ³•
                Object.values(lessonsData).forEach(lesson => {
                    lesson.grammar.forEach(grammar => {
                        const progress = StorageManager.getCardProgress(grammar.id);
                        if (progress.status === 'new' && newCards.length < limit) {
                            newCards.push({...grammar, progress});
                        }
                    });
                });
                
                return newCards;
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼Œé‡æ–°å¼€å§‹
            console.log('ğŸ”„ å¼ºåˆ¶é‡ç½®æ‰€æœ‰æ•°æ®...');
            localStorage.clear(); // æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨
            
            // é‡æ–°è®¾ç½®åˆå§‹åŒ–æ ‡è®°
            localStorage.setItem('appInitialized', 'true');
            console.log('âœ… ç³»ç»Ÿå·²å®Œå…¨é‡ç½®ï¼Œå‡†å¤‡æ¥æ”¶æ–°å†…å®¹');
            
            updateStats();
            updateCounts();
        }

        // åŠ è½½è‡ªå®šä¹‰è¯­æ³•å†…å®¹ï¼ˆæš‚æ—¶ç¦ç”¨ï¼Œç¡®ä¿ç³»ç»Ÿæ¸…ç©ºï¼‰
        function loadCustomLessons() {
            // æš‚æ—¶æ³¨é‡Šæ‰ï¼Œç¡®ä¿ç³»ç»Ÿå®Œå…¨æ¸…ç©º
            /*
            const customLessons = localStorage.getItem('customLessons');
            if (customLessons) {
                try {
                    const customData = JSON.parse(customLessons);
                    // åˆå¹¶è‡ªå®šä¹‰æ•°æ®åˆ°ç°æœ‰æ•°æ®
                    Object.assign(lessonsData, customData);
                    console.log('ğŸ“¤ å·²åŠ è½½è‡ªå®šä¹‰è¯­æ³•å†…å®¹');
                } catch (error) {
                    console.error('åŠ è½½è‡ªå®šä¹‰è¯­æ³•å¤±è´¥:', error);
                }
            }
            */
            console.log('ğŸ“ è‡ªå®šä¹‰è¯­æ³•åŠ è½½å·²ç¦ç”¨ï¼Œç³»ç»Ÿä¿æŒæ¸…ç©ºçŠ¶æ€');
        }

        // é‡ç½®æ‰€æœ‰å­¦ä¹ æ•°æ®ï¼ˆä»…åœ¨éœ€è¦æ—¶è°ƒç”¨ï¼‰
        function resetAllProgress() {
            localStorage.removeItem('cardProgress');
            localStorage.removeItem('todayStats');
            localStorage.removeItem('checkinData');
            localStorage.removeItem('appSettings');
            localStorage.removeItem('customLessons'); // æ¸…é™¤è‡ªå®šä¹‰è¯¾ç¨‹æ•°æ®
        }

        // æ‰‹åŠ¨é‡ç½®è¿›åº¦ï¼ˆåœ¨è®¾ç½®ä¸­æä¾›ç»™ç”¨æˆ·ï¼‰
        function manualResetProgress() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                resetAllProgress();
                localStorage.removeItem('appInitialized'); // é‡ç½®åˆå§‹åŒ–æ ‡è®°
                alert('å­¦ä¹ è¿›åº¦å·²é‡ç½®ï¼é¡µé¢å°†åˆ·æ–°ã€‚');
                location.reload();
            }
        }

        function updateStats() {
            const stats = StorageManager.getTodayStats();
            document.getElementById('today-new').textContent = stats.newCards || 0;
            document.getElementById('today-review').textContent = stats.reviewCards || 0;
            
            const dueCount = SpacedRepetition.getDueCards().length;
            document.getElementById('due-count').textContent = dueCount;
        }

        function updateCounts() {
            const newCards = SpacedRepetition.getNewCards().length;
            const dueCards = SpacedRepetition.getDueCards().length;
            
            document.getElementById('new-count').textContent = newCards;
            document.getElementById('review-count').textContent = dueCards;
        }

        // æ˜¾ç¤ºè¯¾ç¨‹åˆ—è¡¨
        function showLessonList(mode) {
            studyMode = mode;
            currentMode = 'lesson-list';
            
            document.getElementById('main-menu').classList.remove('active');
            document.getElementById('lesson-list').classList.add('active');
            
            const title = mode === 'learn' ? 'é€‰æ‹©è¦å­¦ä¹ çš„è¯¾ç¨‹' : 'æµè§ˆè¯¾ç¨‹';
            document.getElementById('lesson-list-title').textContent = title;
            
            renderLessonList();
        }

        function renderLessonList() {
            const container = document.getElementById('lessons-container');
            container.innerHTML = '';
            
            Object.entries(lessonsData).forEach(([lessonId, lesson]) => {
                const lessonDiv = document.createElement('div');
                lessonDiv.className = 'lesson-item';
                lessonDiv.onclick = () => selectLesson(lessonId);
                
                // è®¡ç®—è¿›åº¦
                const totalGrammar = lesson.grammar.length;
                let learnedCount = 0;
                lesson.grammar.forEach(grammar => {
                    const progress = StorageManager.getCardProgress(grammar.id);
                    if (progress.status !== 'new') learnedCount++;
                });
                
                const progressPercent = totalGrammar > 0 ? (learnedCount / totalGrammar) * 100 : 0;
                
                lessonDiv.innerHTML = `
                    <div>
                        <div class="lesson-title">${lesson.title}</div>
                        <div class="lesson-subtitle">${lesson.subtitle}</div>
                    </div>
                    <div class="lesson-progress">
                        <div class="progress-text">${learnedCount}/${totalGrammar}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                `;
                
                container.appendChild(lessonDiv);
            });
        }

        function selectLesson(lessonId) {
            currentLesson = lessonId;
            
            if (studyMode === 'learn') {
                startLessonStudy(lessonId);
            } else {
                showGrammarList(lessonId);
            }
        }

        // æ˜¾ç¤ºè¯­æ³•åˆ—è¡¨
        function showGrammarList(lessonId) {
            currentMode = 'grammar-list';
            
            document.getElementById('lesson-list').classList.remove('active');
            document.getElementById('grammar-list').classList.add('active');
            
            const lesson = lessonsData[lessonId];
            document.getElementById('grammar-list-title').textContent = `${lesson.title} - ${lesson.subtitle}`;
            
            renderGrammarList(lesson.grammar);
        }

        function renderGrammarList(grammarList) {
            const container = document.getElementById('grammar-container');
            container.innerHTML = '';
            
            grammarList.forEach(grammar => {
                const progress = StorageManager.getCardProgress(grammar.id);
                
                const grammarDiv = document.createElement('div');
                grammarDiv.className = 'grammar-item';
                grammarDiv.onclick = () => studySingleGrammar(grammar);
                
                let statusText = 'æ–°å¡ç‰‡';
                let statusClass = 'status-new';
                let nextReviewText = '';
                
                switch(progress.status) {
                    case 'learning':
                        statusText = 'å­¦ä¹ ä¸­';
                        statusClass = 'status-learning';
                        break;
                    case 'review':
                        statusText = 'å¤ä¹ ä¸­';
                        statusClass = 'status-review';
                        break;
                    case 'mastered':
                        statusText = 'å·²æŒæ¡';
                        statusClass = 'status-mastered';
                        break;
                }
                
                if (progress.nextReview) {
                    const nextDate = new Date(progress.nextReview);
                    const now = new Date();
                    const diffDays = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= 0) {
                        nextReviewText = 'å¾…å¤ä¹ ';
                    } else if (diffDays === 1) {
                        nextReviewText = 'æ˜å¤©å¤ä¹ ';
                    } else {
                        nextReviewText = `${diffDays}å¤©åå¤ä¹ `;
                    }
                }
                
                grammarDiv.innerHTML = `
                    <div class="grammar-pattern">${grammar.pattern}</div>
                    <div class="grammar-meaning">${grammar.meaning}</div>
                    <div class="grammar-status">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <span class="next-review">${nextReviewText}</span>
                    </div>
                `;
                
                container.appendChild(grammarDiv);
            });
        }

        // å¼€å§‹å­¦ä¹ 
        function startLessonStudy(lessonId) {
            const lesson = lessonsData[lessonId];
            const newCards = lesson.grammar.filter(grammar => {
                const progress = StorageManager.getCardProgress(grammar.id);
                return progress.status === 'new';
            });
            
            if (newCards.length === 0) {
                alert('è¿™ä¸€è¯¾çš„æ‰€æœ‰è¯­æ³•éƒ½å·²ç»å­¦è¿‡äº†ï¼');
                return;
            }
            
            currentStudyCards = newCards.slice(0, 5); // é™åˆ¶æ¯æ¬¡å­¦ä¹ 5ä¸ª
            startStudySession();
        }

        function startReview() {
            const dueCards = SpacedRepetition.getDueCards();
            
            if (dueCards.length === 0) {
                alert('æš‚æ—¶æ²¡æœ‰éœ€è¦å¤ä¹ çš„è¯­æ³•ï¼');
                return;
            }
            
            currentStudyCards = dueCards;
            studyMode = 'review';
            startStudySession();
        }

        function studySingleGrammar(grammar) {
            currentStudyCards = [grammar];
            studyMode = 'browse';
            startStudySession();
        }

        function startStudySession() {
            currentMode = 'study';
            currentCardIndex = 0;
            isCardFlipped = false;
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('study-screen').classList.add('active');
            
            showCurrentCard();
        }

        function showCurrentCard() {
            if (currentCardIndex >= currentStudyCards.length) {
                finishStudySession();
                return;
            }
            
            const card = currentStudyCards[currentCardIndex];
            isCardFlipped = false;
            
            // æ›´æ–°è¿›åº¦ - æ˜¾ç¤ºå®é™…çš„å¡ç‰‡ä½ç½®å’Œæ€»æ•°ï¼ˆåŒ…æ‹¬é‡å¤çš„å¡ç‰‡ï¼‰
            const progressText = `ç¬¬ ${currentCardIndex + 1} å¼  / å…± ${currentStudyCards.length} å¼ `;
            document.getElementById('study-progress-text').textContent = progressText;
            
            // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯” - åŸºäºå·²å®Œæˆçš„å”¯ä¸€å¡ç‰‡æ•°é‡
            const uniqueCards = new Set();
            const completedUniqueCards = new Set();
            
            // ç»Ÿè®¡æ‰€æœ‰å”¯ä¸€å¡ç‰‡
            currentStudyCards.forEach(c => uniqueCards.add(c.id));
            
            // ç»Ÿè®¡å·²ç»å¤„ç†è¿‡çš„å”¯ä¸€å¡ç‰‡ï¼ˆä¸åŒ…æ‹¬å½“å‰å¡ç‰‡ï¼‰
            for (let i = 0; i < currentCardIndex; i++) {
                const processedCard = currentStudyCards[i];
                const progress = StorageManager.getCardProgress(processedCard.id);
                // å¦‚æœè¿™å¼ å¡ç‰‡å·²ç»æ¯•ä¸šï¼ˆä¸ä¼šå†åœ¨æœ¬æ¬¡ä¼šè¯ä¸­å‡ºç°ï¼‰ï¼Œåˆ™ç®—ä½œå®Œæˆ
                if (progress.status === 'review' || progress.status === 'mastered' || 
                    (progress.status === 'learning' && progress.learningStep >= 2)) {
                    completedUniqueCards.add(processedCard.id);
                }
            }
            
            const progressPercent = uniqueCards.size > 0 ? 
                (completedUniqueCards.size / uniqueCards.size) * 100 : 
                ((currentCardIndex + 1) / currentStudyCards.length) * 100;
            
            document.getElementById('study-progress-bar').style.width = progressPercent + '%';
            
            // æ˜¾ç¤ºå¡ç‰‡æ­£é¢
            document.getElementById('study-pattern').textContent = card.pattern;
            document.getElementById('card-front').classList.remove('hidden');
            document.getElementById('card-back').classList.add('hidden');
            document.getElementById('study-buttons').classList.add('hidden');
            
            // å‡†å¤‡å¡ç‰‡èƒŒé¢å†…å®¹
            document.getElementById('study-meaning').textContent = card.meaning;
            document.getElementById('study-connection').textContent = card.connection;
            document.getElementById('study-notes').textContent = card.notes;
            
            displayExamples(card.examples);
            
            // æ˜¾ç¤ºå¡ç‰‡çŠ¶æ€ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼Œå¯é€‰ï¼‰
            const progress = StorageManager.getCardProgress(card.id);
            console.log(`å¡ç‰‡ ${card.pattern}: çŠ¶æ€=${progress.status}, å­¦ä¹ æ­¥éª¤=${progress.learningStep || 0}, å¤ä¹ æ¬¡æ•°=${progress.reviewCount}`);
        }

        function flipCard() {
            if (isCardFlipped) return;
            
            isCardFlipped = true;
            document.getElementById('card-front').classList.add('hidden');
            document.getElementById('card-back').classList.remove('hidden');
            document.getElementById('study-buttons').classList.remove('hidden');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            updateButtonIntervals();
        }

        function updateButtonIntervals() {
            const card = currentStudyCards[currentCardIndex];
            const progress = StorageManager.getCardProgress(card.id);
            
            // æ ¹æ®å½“å‰çŠ¶æ€å’Œå­¦ä¹ æ­¥éª¤è®¡ç®—é—´éš”
            let intervals = {};
            
            if (progress.status === 'new' || progress.status === 'learning') {
                // å­¦ä¹ é˜¶æ®µ
                intervals = {
                    1: '1åˆ†é’Ÿ',    // é‡æ¥ï¼šå›åˆ°ç¬¬ä¸€æ­¥
                    2: '6åˆ†é’Ÿ',    // å›°éš¾ï¼šå›åˆ°ç¬¬ä¸€æ­¥ä½†ç¨é•¿
                    3: progress.learningStep === 0 ? '10åˆ†é’Ÿ' : '1å¤©',  // è‰¯å¥½ï¼šä¸‹ä¸€æ­¥æˆ–æ¯•ä¸š
                    4: '4å¤©'       // ç®€å•ï¼šç›´æ¥æ¯•ä¸šåˆ°é•¿é—´éš”
                };
            } else {
                // å¤ä¹ é˜¶æ®µ
                const currentInterval = progress.interval || 1;
                const easeFactor = progress.easeFactor || 2.5;
                
                intervals = {
                    1: '1åˆ†é’Ÿ',    // é‡æ¥ï¼šå›åˆ°å­¦ä¹ é˜¶æ®µ
                    2: '6åˆ†é’Ÿ',    // å›°éš¾ï¼šå›åˆ°å­¦ä¹ é˜¶æ®µ
                    3: `${Math.round(currentInterval * easeFactor)}å¤©`,  // è‰¯å¥½ï¼šæ­£å¸¸é—´éš”
                    4: `${Math.round(currentInterval * easeFactor * 1.3)}å¤©`  // ç®€å•ï¼šæ›´é•¿é—´éš”
                };
            }
            
            document.querySelector('.btn-again small').textContent = intervals[1];
            document.querySelector('.btn-hard small').textContent = intervals[2];
            document.querySelector('.btn-good small').textContent = intervals[3];
            document.querySelector('.btn-easy small').textContent = intervals[4];
        }

        function answerCard(quality) {
            const card = currentStudyCards[currentCardIndex];
            let progress = StorageManager.getCardProgress(card.id);
            
            // æ›´æ–°è¿›åº¦
            const result = SpacedRepetition.calculateNextReview(progress, quality);
            progress = result.progress;
            const graduated = result.graduated;
            
            StorageManager.saveCardProgress(card.id, progress);
            
            // æ›´æ–°ç»Ÿè®¡
            if (progress.reviewCount === 1) {
                StorageManager.updateTodayStats('new');
            } else {
                StorageManager.updateTodayStats('review');
            }
            
            // Ankiæ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæ²¡æœ‰æ¯•ä¸šï¼ˆå›ç­”é”™è¯¯æˆ–è¿˜åœ¨å­¦ä¹ é˜¶æ®µï¼‰ï¼Œå¡ç‰‡éœ€è¦é‡æ–°åŠ å…¥é˜Ÿåˆ—
            if (!graduated) {
                // å°†å½“å‰å¡ç‰‡é‡æ–°åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œä½†ä¸æ˜¯ç«‹å³é‡å¤
                // è€Œæ˜¯åœ¨å‡ å¼ å¡ç‰‡åé‡æ–°å‡ºç°
                const reinsertPosition = Math.min(currentCardIndex + 3, currentStudyCards.length);
                const cardToReinsert = {...card};
                cardToReinsert.progress = progress; // æ›´æ–°è¿›åº¦ä¿¡æ¯
                
                // å¦‚æœè¿˜æ²¡åˆ°é˜Ÿåˆ—æœ«å°¾ï¼Œæ’å…¥åˆ°åé¢å‡ å¼ å¡ç‰‡çš„ä½ç½®
                if (reinsertPosition < currentStudyCards.length) {
                    currentStudyCards.splice(reinsertPosition, 0, cardToReinsert);
                } else {
                    // å¦‚æœå·²ç»æ˜¯æœ€åå‡ å¼ å¡ç‰‡ï¼Œç›´æ¥æ·»åŠ åˆ°æœ«å°¾
                    currentStudyCards.push(cardToReinsert);
                }
            }
            
            // ç§»åŠ¨åˆ°ä¸‹ä¸€å¼ å¡ç‰‡
            currentCardIndex++;
            setTimeout(() => {
                showCurrentCard();
            }, 300);
        }

        function finishStudySession() {
            const message = studyMode === 'review' ? 
                `æ­å–œï¼æ‚¨å·²å®Œæˆ ${currentStudyCards.length} å¼ å¡ç‰‡çš„å¤ä¹ ã€‚` :
                `æ­å–œï¼æ‚¨å·²å­¦ä¹  ${currentStudyCards.length} å¼ æ–°å¡ç‰‡ã€‚`;
            
            alert(message);
            backToMenu();
        }

        // æ˜¾ç¤ºä¾‹å¥
        function displayExamples(examples) {
            const container = document.getElementById('study-examples');
            container.innerHTML = '<h4 style="margin-top: 0; color: #333;">ä¾‹å¥ï¼š</h4>';
            
            const currentCard = currentStudyCards[currentCardIndex];
            
            examples.forEach((example, index) => {
                const exampleDiv = document.createElement('div');
                exampleDiv.className = 'example-item';
                exampleDiv.onclick = () => speakJapanese(example.japanese);
                
                const processedJapanese = processJapaneseText(example.japanese, example.furigana, currentCard.pattern);
                
                exampleDiv.innerHTML = `
                    <div class="example-japanese">${processedJapanese}</div>
                    <div class="example-chinese">${example.chinese}</div>
                    ${example.analysis ? `<div style="font-size: 12px; color: #007bff; margin-top: 8px; padding: 8px; background: #f0f8ff; border-radius: 5px; border-left: 3px solid #007bff;">${example.analysis}</div>` : ''}
                `;
                
                container.appendChild(exampleDiv);
            });
            
            // å¦‚æœæœ‰è¯¦ç»†è§£é‡Šï¼Œæ·»åŠ åˆ°ä¾‹å¥åé¢
            if (currentCard.detailedExplanation) {
                const explanationDiv = document.createElement('div');
                explanationDiv.style.cssText = `
                    background: #f8f9fa;
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    padding: 15px;
                    margin-top: 15px;
                    font-size: 14px;
                    line-height: 1.6;
                    color: #495057;
                    white-space: pre-line;
                `;
                explanationDiv.innerHTML = `<h5 style="margin: 0 0 10px 0; color: #333;">ğŸ“– è¯¦ç»†è§£é‡Š</h5>${currentCard.detailedExplanation}`;
                container.appendChild(explanationDiv);
            }
        }

        // å¤„ç†æ—¥è¯­æ–‡æœ¬ï¼ˆå‡åæ ‡æ³¨å’Œè¯­æ³•é«˜äº®ï¼‰
        function processJapaneseText(japanese, furigana, grammarPattern) {
            const furiganaMatches = furigana.match(/([^(]+)\(([^)]+)\)/g) || [];
            let processedText = japanese;
            
            const furiganaMap = {};
            furiganaMatches.forEach(match => {
                const [, kanji, reading] = match.match(/([^(]+)\(([^)]+)\)/);
                furiganaMap[kanji] = reading;
            });
            
            // è·å–å½“å‰è¯¾ç¨‹çš„æ‰€æœ‰è¯­æ³•ç‚¹
            const currentCard = currentStudyCards[currentCardIndex];
            const currentLesson = getCurrentLessonFromCard(currentCard);
            const allGrammarKeywords = getAllGrammarKeywordsFromLesson(currentLesson);
            
            let result = processedText;
            
            // å¤„ç†è¯­æ³•é«˜äº® - ä½¿ç”¨æ›´æ™ºèƒ½çš„åŒ¹é…
            allGrammarKeywords.forEach(keyword => {
                if (result.includes(keyword)) {
                    // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œé¿å…é‡å¤æ›¿æ¢
                    const regex = new RegExp(`(?<!<[^>]*>)${escapeRegExp(keyword)}(?![^<]*>)`, 'g');
                    result = result.replace(regex, `<span class="grammar-highlight">${keyword}</span>`);
                }
            });
            
            // å¤„ç†å‡åæ ‡æ³¨
            Object.keys(furiganaMap).forEach(kanji => {
                const reading = furiganaMap[kanji];
                if (result.includes(kanji) && !result.includes(`<span class="grammar-highlight">${kanji}</span>`)) {
                    const regex = new RegExp(`(?<!<[^>]*>)${escapeRegExp(kanji)}(?![^<]*>)`, 'g');
                    result = result.replace(regex, 
                        `<span class="furigana-text">${kanji}<span class="furigana">${reading}</span></span>`);
                }
            });
            
            // å¤„ç†è¯­æ³•é«˜äº®ä¸­çš„å‡åæ ‡æ³¨
            allGrammarKeywords.forEach(keyword => {
                Object.keys(furiganaMap).forEach(kanji => {
                    if (keyword.includes(kanji)) {
                        const reading = furiganaMap[kanji];
                        const highlightedKeyword = `<span class="grammar-highlight">${keyword}</span>`;
                        if (result.includes(highlightedKeyword)) {
                            const newKeyword = keyword.replace(kanji, 
                                `<span class="furigana-text">${kanji}<span class="furigana">${reading}</span></span>`);
                            result = result.replace(highlightedKeyword, 
                                `<span class="grammar-highlight">${newKeyword}</span>`);
                        }
                    }
                });
            });
            
            return result;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // è·å–å½“å‰å¡ç‰‡æ‰€å±çš„è¯¾ç¨‹
        function getCurrentLessonFromCard(card) {
            for (const [lessonId, lesson] of Object.entries(lessonsData)) {
                if (lesson.grammar.some(g => g.id === card.id)) {
                    return lesson;
                }
            }
            return null;
        }

        // è·å–è¯¾ç¨‹ä¸­æ‰€æœ‰è¯­æ³•ç‚¹çš„å…³é”®è¯
        function getAllGrammarKeywordsFromLesson(lesson) {
            if (!lesson) return [];
            
            const allKeywords = new Set();
            
            lesson.grammar.forEach(grammar => {
                const keywords = extractGrammarKeywords(grammar.pattern);
                keywords.forEach(keyword => allKeywords.add(keyword));
            });
            
            return Array.from(allKeywords).sort((a, b) => b.length - a.length); // æŒ‰é•¿åº¦æ’åºï¼Œä¼˜å…ˆåŒ¹é…é•¿çš„
        }

        // å¢å¼ºçš„è¯­æ³•å…³é”®è¯æå–å‡½æ•°
        function extractGrammarKeywords(pattern) {
            const keywords = [];
            
            // ç§»é™¤è¯­æ³•æ¨¡å¼ä¸­çš„ç¬¦å·ï¼Œæå–æ ¸å¿ƒéƒ¨åˆ†
            const cleanPattern = pattern.replace(/[ï½ã€œ]/g, '').replace(/[ï¼ˆï¼‰()]/g, '');
            
            // åŸºç¡€è¯­æ³•ç‚¹æå–
            if (pattern.includes('éš›')) {
                keywords.push('éš›ã¯', 'éš›ã«', 'éš›');
            }
            if (pattern.includes('ã«éš›ã—ã¦')) {
                keywords.push('ã«éš›ã—ã¦');
            }
            if (pattern.includes('ã«ã‚ãŸã£ã¦')) {
                keywords.push('ã«ã‚ãŸã£ã¦');
            }
            if (pattern.includes('ã¨ãŸã‚“')) {
                keywords.push('ã¨ãŸã‚“ã«', 'ã¨ãŸã‚“');
            }
            if (pattern.includes('ã¨æ€ã†ã¨')) {
                keywords.push('ã¨æ€ã†ã¨');
            }
            if (pattern.includes('ã¨æ€ã£ãŸã‚‰')) {
                keywords.push('ã¨æ€ã£ãŸã‚‰');
            }
            if (pattern.includes('é€”ç«¯')) {
                keywords.push('é€”ç«¯ã«', 'é€”ç«¯');
            }
            if (pattern.includes('ã‹ã®ã†ã¡ã«')) {
                keywords.push('ã‹ã®ã†ã¡ã«', 'ã‹ãªã‚‰ãªã„ã‹ã®ã†ã¡ã«');
            }
            
            // å¸¸è§è¯­æ³•æ¨¡å¼
            if (pattern.includes('ã†ã¡ã«')) {
                keywords.push('ã†ã¡ã«');
            }
            if (pattern.includes('æœ€ä¸­')) {
                keywords.push('æœ€ä¸­ã«', 'æœ€ä¸­ã ', 'æœ€ä¸­');
            }
            if (pattern.includes('ã°ã‹ã‚Šã ')) {
                keywords.push('ã°ã‹ã‚Šã ', 'ã°ã‹ã‚Š');
            }
            if (pattern.includes('ä¸€æ–¹ã ')) {
                keywords.push('ä¸€æ–¹ã ', 'ä¸€æ–¹');
            }
            if (pattern.includes('ã‚ˆã†ã¨ã—ã¦ã„ã‚‹')) {
                keywords.push('ã‚ˆã†ã¨ã—ã¦ã„ã‚‹', 'ã‚ˆã†ã¨ã—ã¦');
            }
            if (pattern.includes('ã¤ã¤ã‚ã‚‹')) {
                keywords.push('ã¤ã¤ã‚ã‚‹');
            }
            if (pattern.includes('ã¤ã¤')) {
                keywords.push('ã¤ã¤');
            }
            
            // åŠ¨æ€æå–ï¼šç›´æ¥ä»è¯­æ³•æ¨¡å¼ä¸­æå–å¯èƒ½çš„å…³é”®è¯
            const dynamicKeywords = extractDynamicKeywords(cleanPattern);
            keywords.push(...dynamicKeywords);
            
            // å»é‡å¹¶æŒ‰é•¿åº¦æ’åºï¼ˆé•¿çš„ä¼˜å…ˆåŒ¹é…ï¼‰
            return [...new Set(keywords)].sort((a, b) => b.length - a.length);
        }

        // åŠ¨æ€æå–è¯­æ³•å…³é”®è¯
        function extractDynamicKeywords(pattern) {
            const keywords = [];
            
            // æå–å¹³å‡åå’Œç‰‡å‡ååºåˆ—
            const hiraganaMatches = pattern.match(/[ã-ã‚Ÿ]+/g) || [];
            const katakanaMatches = pattern.match(/[ã‚¡-ãƒ¿]+/g) || [];
            
            keywords.push(...hiraganaMatches);
            keywords.push(...katakanaMatches);
            
            // æå–æ±‰å­—åºåˆ—
            const kanjiMatches = pattern.match(/[ä¸€-é¾¯]+/g) || [];
            keywords.push(...kanjiMatches);
            
            // æå–å¸¸è§çš„è¯­æ³•ç»“å°¾
            const commonEndings = ['ã ', 'ã§ã‚ã‚‹', 'ã§ã™', 'ã¾ã™', 'ãŸ', 'ã¦', 'ã«', 'ã‚’', 'ãŒ', 'ã¯', 'ã®'];
            commonEndings.forEach(ending => {
                if (pattern.includes(ending)) {
                    keywords.push(ending);
                }
            });
            
            return keywords.filter(k => k.length >= 2); // åªä¿ç•™é•¿åº¦>=2çš„å…³é”®è¯
        }

        // è¯­éŸ³åŠŸèƒ½
        function speakJapanese(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        // å¯¼èˆªåŠŸèƒ½
        function backToMenu() {
            currentMode = 'menu';
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('main-menu').classList.add('active');
            
            updateStats();
            updateCounts();
        }

        function backToLessonList() {
            document.getElementById('grammar-list').classList.remove('active');
            document.getElementById('lesson-list').classList.add('active');
            currentMode = 'lesson-list';
        }

        // ç»Ÿè®¡åŠŸèƒ½
        function showStats() {
            currentMode = 'stats';
            document.getElementById('main-menu').classList.remove('active');
            document.getElementById('stats-screen').classList.add('active');
            
            renderStats();
        }

        // ä¸Šä¼ åŠŸèƒ½
        function showUpload() {
            currentMode = 'upload';
            document.getElementById('main-menu').classList.remove('active');
            document.getElementById('upload-screen').classList.add('active');
            
            initUploadArea();
        }

        let parsedData = null; // å­˜å‚¨è§£æåçš„æ•°æ®

        function initUploadArea() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const uploadResult = document.getElementById('upload-result');
            
            // é‡ç½®çŠ¶æ€
            uploadResult.style.display = 'none';
            parsedData = null;
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
            uploadArea.onclick = () => fileInput.click();
            
            // æ–‡ä»¶é€‰æ‹©
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            };
            
            // æ‹–æ‹½åŠŸèƒ½
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            };
            
            uploadArea.ondragleave = () => {
                uploadArea.classList.remove('dragover');
            };
            
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                        handleFileUpload(file);
                    } else {
                        showError('è¯·é€‰æ‹© .txt æ ¼å¼çš„æ–‡ä»¶');
                    }
                }
            };
        }

        function handleFileUpload(file) {
            if (!file.name.endsWith('.txt')) {
                showError('è¯·é€‰æ‹© .txt æ ¼å¼çš„æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                try {
                    parsedData = parseGrammarFile(content);
                    displayParseResult(parsedData);
                } catch (error) {
                    showError('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message);
                }
            };
            
            reader.onerror = () => {
                showError('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function parseGrammarFile(content) {
            try {
                const lines = content.split('\n').map(line => line.trim()).filter(line => line);
                
                if (lines.length === 0) {
                    throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                }
                
                const lessons = {};
                let currentLesson = null;
                let currentGrammar = null;
                let parseState = 'looking_for_lesson';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // åŒ¹é…è¯¾ç¨‹æ ‡é¢˜ï¼šç¬¬1è¯¾ã€ç¬¬01è¯¾ã€ç¬¬ä¸€è¯¾ç­‰æ ¼å¼
                    if (line.match(/^ç¬¬[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+è¯¾/) || line.match(/^ç¬¬\d+è¯¾/)) {
                        const lessonMatch = line.match(/ç¬¬(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)è¯¾/);
                        if (lessonMatch) {
                            let lessonNumber;
                            const numStr = lessonMatch[1];
                            
                            // è½¬æ¢ä¸­æ–‡æ•°å­—æˆ–é˜¿æ‹‰ä¼¯æ•°å­—
                            if (isNaN(numStr)) {
                                const chineseNumbers = {'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10};
                                lessonNumber = chineseNumbers[numStr] || parseInt(numStr);
                            } else {
                                lessonNumber = parseInt(numStr);
                            }
                            
                            currentLesson = lessonNumber;
                            
                            if (!lessons[currentLesson]) {
                                lessons[currentLesson] = {
                                    title: (typeof lessonsData !== 'undefined' && lessonsData[currentLesson]) ? lessonsData[currentLesson].title : line,
                                    subtitle: (typeof lessonsData !== 'undefined' && lessonsData[currentLesson]) ? lessonsData[currentLesson].subtitle : "è‡ªå®šä¹‰è¯­æ³•",
                                    grammar: []
                                };
                            }
                            parseState = 'looking_for_example';
                            continue;
                        }
                    }
                    
                    if (!currentLesson) {
                        continue;
                    }
                    
                    if (parseState === 'looking_for_example') {
                        // è·³è¿‡ç©ºè¡Œå’Œéæ—¥è¯­å†…å®¹
                        if (line.length === 0 || !/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(line)) {
                            continue;
                        }
                        
                        const grammarId = Date.now() + Math.random() + lessons[currentLesson].grammar.length;
                        currentGrammar = {
                            id: grammarId,
                            pattern: '',
                            meaning: '',
                            connection: '',
                            notes: '',
                            examples: [{
                                japanese: line,
                                furigana: line,
                                chinese: ''
                            }]
                        };
                        parseState = 'looking_for_translation';
                        continue;
                    }
                    
                    if (parseState === 'looking_for_translation') {
                        if (currentGrammar && currentGrammar.examples.length > 0) {
                            currentGrammar.examples[0].chinese = line;
                        }
                        parseState = 'looking_for_grammar';
                        continue;
                    }
                    
                    if (parseState === 'looking_for_grammar') {
                        // åŒ¹é…è¯­æ³•è§£é‡Šï¼šã€Œè¯­æ³•ã€ï¼šè§£é‡Š æˆ– ã€Œè¯­æ³•ã€:è§£é‡Š
                        if (line.includes('ã€Œ') && line.includes('ã€')) {
                            const grammarMatch = line.match(/ã€Œ([^ã€]+)ã€[ï¼š:]\s*(.+)/);
                            if (grammarMatch) {
                                const grammarPattern = grammarMatch[1];
                                const explanation = grammarMatch[2];
                                
                                currentGrammar.pattern = grammarPattern;
                                currentGrammar.meaning = explanation;
                                
                                if (currentGrammar.examples[0]) {
                                    currentGrammar.examples[0].furigana = highlightGrammarInSentence(
                                        currentGrammar.examples[0].japanese, 
                                        grammarPattern
                                    );
                                }
                            }
                            
                            lessons[currentLesson].grammar.push(currentGrammar);
                            currentGrammar = null;
                            parseState = 'looking_for_example';
                        } else {
                            // ç»§ç»­æ”¶é›†è¯­æ³•è¯´æ˜
                            if (currentGrammar) {
                                currentGrammar.notes += (currentGrammar.notes ? ' ' : '') + line;
                            }
                        }
                        continue;
                    }
                }
                
                // å¤„ç†æœ€åä¸€ä¸ªè¯­æ³•é¡¹
                if (currentGrammar && currentLesson) {
                    lessons[currentLesson].grammar.push(currentGrammar);
                }
                
                if (Object.keys(lessons).length === 0) {
                    throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¯­æ³•å†…å®¹ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚\n\næœŸæœ›æ ¼å¼ï¼š\nç¬¬1è¯¾\næ—¥è¯­ä¾‹å¥\nä¸­æ–‡ç¿»è¯‘\nã€Œè¯­æ³•ã€ï¼šè§£é‡Š');
                }
                
                return lessons;
                
            } catch (error) {
                throw new Error('è§£æå¤±è´¥: ' + error.message);
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šåœ¨å¥å­ä¸­é«˜äº®è¯­æ³•éƒ¨åˆ†
        function highlightGrammarInSentence(sentence, grammarPattern) {
            // ç§»é™¤è¯­æ³•æ¨¡å¼ä¸­çš„ç‰¹æ®Šç¬¦å·ï¼Œæå–æ ¸å¿ƒéƒ¨åˆ†
            let corePattern = grammarPattern.replace(/[ï½ã€œ]/g, '').replace(/[ï¼ˆï¼‰()]/g, '');
            
            // å¤„ç†ä¸€äº›å¸¸è§çš„è¯­æ³•æ¨¡å¼
            const patterns = [
                corePattern,
                corePattern.replace(/ã«$/, ''),
                corePattern.replace(/ã $/, ''),
                corePattern.replace(/ã§ã‚ã‚‹$/, ''),
            ];
            
            let result = sentence;
            
            // å°è¯•åŒ¹é…å’Œé«˜äº®
            for (const pattern of patterns) {
                if (pattern && sentence.includes(pattern)) {
                    // ç®€å•çš„é«˜äº®å¤„ç†ï¼Œå®é™…ä½¿ç”¨æ—¶ä¼šåœ¨æ˜¾ç¤ºæ—¶å¤„ç†
                    break;
                }
            }
            
            return result;
        }

        function displayParseResult(data) {
            const resultDiv = document.getElementById('upload-result');
            const parseResultDiv = document.getElementById('parse-result');
            
            let html = '';
            let totalGrammar = 0;
            
            Object.entries(data).forEach(([lessonId, lesson]) => {
                totalGrammar += lesson.grammar.length;
                
                html += `
                    <div class="parsed-lesson">
                        <h4>${lesson.title} (${lesson.grammar.length} ä¸ªè¯­æ³•)</h4>
                `;
                
                lesson.grammar.forEach((grammar, index) => {
                    html += `
                        <div class="parsed-grammar">
                            <div class="parsed-pattern">${grammar.pattern}</div>
                            <div class="parsed-meaning">${grammar.meaning}</div>
                            ${grammar.connection ? `<div class="parsed-meaning">æ¥ç»­ï¼š${grammar.connection}</div>` : ''}
                            ${grammar.notes ? `<div class="parsed-meaning">æ³¨æ„ï¼š${grammar.notes}</div>` : ''}
                            <div class="parsed-examples">
                                ${grammar.examples.length} ä¸ªä¾‹å¥
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            parseResultDiv.innerHTML = `
                <div class="success-message">
                    âœ… è§£ææˆåŠŸï¼å…±æ‰¾åˆ° ${Object.keys(data).length} ä¸ªè¯¾ç¨‹ï¼Œ${totalGrammar} ä¸ªè¯­æ³•æ¡ç›®
                </div>
                ${html}
            `;
            
            resultDiv.style.display = 'block';
        }

        function confirmUpload() {
            if (!parsedData) {
                showError('æ²¡æœ‰å¯æ·»åŠ çš„æ•°æ®');
                return;
            }
            
            try {
                // åˆå¹¶åˆ°ç°æœ‰æ•°æ®
                Object.entries(parsedData).forEach(([lessonId, lesson]) => {
                    if (lessonsData[lessonId]) {
                        // å¦‚æœè¯¾ç¨‹å·²å­˜åœ¨ï¼Œåˆå¹¶è¯­æ³•æ¡ç›®
                        lessonsData[lessonId].grammar = lessonsData[lessonId].grammar.concat(lesson.grammar);
                    } else {
                        // å¦‚æœè¯¾ç¨‹ä¸å­˜åœ¨ï¼Œç›´æ¥æ·»åŠ 
                        lessonsData[lessonId] = lesson;
                    }
                });
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('customLessons', JSON.stringify(lessonsData));
                
                showSuccess('è¯­æ³•å†…å®¹å·²æˆåŠŸæ·»åŠ åˆ°ç³»ç»Ÿä¸­ï¼');
                
                // æ›´æ–°ç»Ÿè®¡
                updateStats();
                updateCounts();
                
                // 3ç§’åè¿”å›ä¸»èœå•
                setTimeout(() => {
                    backToMenu();
                }, 3000);
                
            } catch (error) {
                showError('æ·»åŠ å¤±è´¥ï¼š' + error.message);
            }
        }

        function cancelUpload() {
            parsedData = null;
            document.getElementById('upload-result').style.display = 'none';
            document.getElementById('file-input').value = '';
        }

        function showError(message) {
            const parseResultDiv = document.getElementById('parse-result');
            parseResultDiv.innerHTML = `
                <div class="error-message">
                    âŒ ${message}
                </div>
            `;
            document.getElementById('upload-result').style.display = 'block';
        }

        function showSuccess(message) {
            const parseResultDiv = document.getElementById('parse-result');
            parseResultDiv.innerHTML = `
                <div class="success-message">
                    âœ… ${message}
                </div>
            `;
        }

        function renderStats() {
            const container = document.getElementById('stats-content');
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            let totalCards = 0;
            let newCards = 0;
            let learningCards = 0;
            let reviewCards = 0;
            let masteredCards = 0;
            
            Object.values(lessonsData).forEach(lesson => {
                lesson.grammar.forEach(grammar => {
                    totalCards++;
                    const progress = StorageManager.getCardProgress(grammar.id);
                    switch(progress.status) {
                        case 'new': newCards++; break;
                        case 'learning': learningCards++; break;
                        case 'review': reviewCards++; break;
                        case 'mastered': masteredCards++; break;
                    }
                });
            });
            
            const todayStats = StorageManager.getTodayStats();
            
            container.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333;">ä»Šæ—¥å­¦ä¹ </h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>æ–°å­¦è¯­æ³•ï¼š</span>
                        <span style="color: #007bff; font-weight: bold;">${todayStats.newCards || 0} ä¸ª</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>å¤ä¹ è¯­æ³•ï¼š</span>
                        <span style="color: #28a745; font-weight: bold;">${todayStats.reviewCards || 0} ä¸ª</span>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333;">æ€»ä½“è¿›åº¦</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>æ€»è¯­æ³•æ•°ï¼š</span>
                        <span style="font-weight: bold;">${totalCards} ä¸ª</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>æ–°è¯­æ³•ï¼š</span>
                        <span style="color: #6c757d; font-weight: bold;">${newCards} ä¸ª</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>å­¦ä¹ ä¸­ï¼š</span>
                        <span style="color: #ffc107; font-weight: bold;">${learningCards} ä¸ª</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>å¤ä¹ ä¸­ï¼š</span>
                        <span style="color: #28a745; font-weight: bold;">${reviewCards} ä¸ª</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>å·²æŒæ¡ï¼š</span>
                        <span style="color: #6f42c1; font-weight: bold;">${masteredCards} ä¸ª</span>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px; color: #333;">å­¦ä¹ è¿›åº¦</h3>
                    <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                        <div style="height: 100%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); width: ${totalCards > 0 ? ((totalCards - newCards) / totalCards) * 100 : 0}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="text-align: center; color: #666; font-size: 14px;">
                        å·²å­¦ä¹  ${totalCards - newCards} / ${totalCards} ä¸ªè¯­æ³• (${totalCards > 0 ? Math.round(((totalCards - newCards) / totalCards) * 100) : 0}%)
                    </div>
                </div>
            `;
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });
    </script>
</body>
</html>